{% extends "base_retro.html" %}

{% block title %}Analytics - ExamSeat{% endblock %}

{% block content %}
<div class="page-header">
    <h1>[%] Analytics Dashboard</h1>
</div>

{% if fallback %}
<div class="alert alert-warning mb-2">
    <span>[!]</span> PostgreSQL not configured. Full analytics require PostgreSQL database setup.
</div>
{% endif %}

{% if system_stats %}
<!-- System Overview -->
<div class="grid-4 mb-2">
    <div class="card text-center">
        <div class="card-body">
            <div class="stat-value text-primary">{{ system_stats.total_students }}</div>
            <div class="stat-label">Total Students</div>
        </div>
    </div>
    <div class="card text-center">
        <div class="card-body">
            <div class="stat-value text-success">{{ system_stats.total_rooms }}</div>
            <div class="stat-label">Total Rooms</div>
        </div>
    </div>
    <div class="card text-center">
        <div class="card-body">
            <div class="stat-value" style="color: var(--accent-purple);">{{ system_stats.upcoming_exams }}</div>
            <div class="stat-label">Upcoming Exams</div>
        </div>
    </div>
    <div class="card text-center">
        <div class="card-body">
            <div class="stat-value text-danger">{{ system_stats.unreviewed_flags }}</div>
            <div class="stat-label">Unreviewed Flags</div>
        </div>
    </div>
</div>

<div class="grid-2 mb-2">
    <!-- Today's Exams -->
    <div class="card">
        <div class="card-header">
            <h3>[E] Today's Exams</h3>
        </div>
        <div class="card-body">
            {% if todays_exams %}
            {% for exam in todays_exams %}
            <div class="card mb-1" style="border-left: 4px solid var(--accent-blue);">
                <div class="card-body">
                    <strong>{{ exam.name }}</strong>
                    <p class="text-sm text-muted mb-0">{{ exam.subject }} - {{ exam.exam_time }}</p>
                    <p class="text-sm mb-0">{{ exam.seated_count }}/{{ exam.total_students }} seated in {{ exam.rooms_used }} rooms</p>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted text-center">[...] No exams scheduled for today.</p>
            {% endif %}
        </div>
    </div>

    <!-- Room Utilization -->
    <div class="card">
        <div class="card-header">
            <h3>[R] Room Utilization</h3>
        </div>
        <div class="card-body">
            {% if room_utilization %}
            {% for room in room_utilization %}
            <div class="flex-between mb-1">
                <div>
                    <strong>{{ room.room_name }}</strong>
                    <span class="text-sm text-muted">| Cap: {{ room.capacity }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 80px; height: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                        <div style="width: {{ room.avg_utilization_pct or 0 }}%; height: 100%; background: var(--accent-blue);"></div>
                    </div>
                    <span class="text-sm">{{ room.avg_utilization_pct or 0 }}%</span>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted text-center">[...] No utilization data available.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="grid-2 mb-2">
    <!-- Department Stats -->
    <div class="card">
        <div class="card-header">
            <h3>[D] Department Statistics</h3>
        </div>
        <div class="card-body">
            {% if department_stats %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Department</th>
                        <th>Total</th>
                        <th>Y1</th>
                        <th>Y2</th>
                        <th>Y3</th>
                        <th>Y4</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dept in department_stats %}
                    <tr>
                        <td>{{ dept.department_name }}</td>
                        <td><strong>{{ dept.total_students }}</strong></td>
                        <td>{{ dept.year_1 }}</td>
                        <td>{{ dept.year_2 }}</td>
                        <td>{{ dept.year_3 }}</td>
                        <td>{{ dept.year_4 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted text-center">[...] No department data available.</p>
            {% endif %}
        </div>
    </div>

    <!-- Cheat Detection Summary -->
    <div class="card">
        <div class="card-header">
            <h3>[!] Cheat Detection Flags</h3>
        </div>
        <div class="card-body">
            {% if cheat_summary %}
            {% for flag in cheat_summary %}
            <div class="card mb-1">
                <div class="card-body flex-between">
                    <div>
                        <strong>{{ flag.exam_code }}</strong>
                        <p class="text-sm text-muted mb-0">{{ flag.exam_date }} | {{ flag.flag_type }}</p>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-{% if flag.severity == 'high' or flag.severity == 'critical' %}red{% elif flag.severity == 'medium' %}warning{% else %}gray{% endif %}">
                            {{ flag.flag_count }} flags
                        </span>
                        <p class="text-sm text-muted mb-0">{{ flag.pending_count }} pending</p>
                    </div>
                </div>
            </div>
            {% endfor %}
            <a href="{{ url_for('admin_cheat_flags') }}" class="btn btn-sm" style="display: block; text-align: center; margin-top: 12px;">
                [>] View All Flags
            </a>
            {% else %}
            <p class="text-muted text-center">[...] No cheat flags recorded.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card">
    <div class="card-header">
        <h3>[*] Recent Activity</h3>
    </div>
    <div class="card-body">
        {% if recent_activity %}
        <table class="table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Activity</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in recent_activity %}
                <tr>
                    <td><code>{{ activity.created_at.strftime('%H:%M') if activity.created_at else '-' }}</code></td>
                    <td>{{ activity.username or 'system' }}</td>
                    <td>{{ activity.activity_description }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted text-center">[...] No recent activity.</p>
        {% endif %}
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-4">
        <div class="text-mono" style="font-size: 48px; color: var(--text-muted);">[%]</div>
        <p class="text-muted">Analytics data not available.</p>
        <p class="text-sm text-muted">Please ensure PostgreSQL is configured and views are created.</p>
    </div>
</div>
{% endif %}
{% endblock %}
